// Wine Quality Regression Loss Function
// Network: 11 inputs -> 4 hidden (tanh) -> 1 output (sigmoid)
// Parameters (53 total):
//   pos[0-43]:  W1 (4x11 input->hidden weights, neuron-major)
//   pos[44-47]: b1 (4 hidden biases)
//   pos[48-51]: W2 (4x1 hidden->output weights)
//   pos[52]:    b2 (1 output bias)

// Embedded Wine Quality dataset (30 samples, normalized)
// Features: fixed_acidity, volatile_acidity, citric_acid, residual_sugar,
//           chlorides, free_so2, total_so2, density, pH, sulphates, alcohol
// Target: quality (normalized 0-1)

const WINE_SIZE: u32 = 30u;

const WINE_F0: array<f32, 30> = array<f32, 30>(
    0.247, 0.284, 0.284, 0.432, 0.247, 0.247, 0.272, 0.309, 0.247, 0.210,
    0.358, 0.321, 0.321, 0.432, 0.272, 0.358, 0.148, 0.309, 0.284, 0.235,
    0.407, 0.309, 0.210, 0.296, 0.235, 0.272, 0.173, 0.358, 0.210, 0.247
);
const WINE_F1: array<f32, 30> = array<f32, 30>(
    0.397, 0.521, 0.438, 0.192, 0.397, 0.534, 0.466, 0.315, 0.507, 0.288,
    0.260, 0.192, 0.192, 0.178, 0.260, 0.260, 0.411, 0.315, 0.370, 0.192,
    0.329, 0.247, 0.329, 0.192, 0.274, 0.356, 0.315, 0.178, 0.247, 0.288
);
const WINE_F2: array<f32, 30> = array<f32, 30>(
    0.000, 0.000, 0.040, 0.360, 0.000, 0.020, 0.200, 0.200, 0.020, 0.240,
    0.280, 0.400, 0.400, 0.440, 0.160, 0.280, 0.100, 0.200, 0.160, 0.280,
    0.280, 0.260, 0.120, 0.260, 0.160, 0.000, 0.080, 0.320, 0.360, 0.360
);
const WINE_F3: array<f32, 30> = array<f32, 30>(
    0.069, 0.103, 0.224, 0.069, 0.069, 0.241, 0.155, 0.138, 0.207, 0.207,
    0.086, 0.103, 0.103, 0.121, 0.121, 0.086, 0.155, 0.138, 0.121, 0.069,
    0.328, 0.172, 0.190, 0.259, 0.086, 0.052, 0.241, 0.345, 0.034, 0.379
);
const WINE_F4: array<f32, 30> = array<f32, 30>(
    0.107, 0.107, 0.087, 0.087, 0.107, 0.120, 0.107, 0.093, 0.100, 0.133,
    0.073, 0.080, 0.073, 0.067, 0.100, 0.073, 0.087, 0.093, 0.100, 0.060,
    0.100, 0.080, 0.093, 0.067, 0.087, 0.127, 0.067, 0.067, 0.060, 0.060
);
const WINE_F5: array<f32, 30> = array<f32, 30>(
    0.129, 0.097, 0.194, 0.129, 0.129, 0.355, 0.161, 0.129, 0.274, 0.339,
    0.065, 0.097, 0.113, 0.113, 0.194, 0.065, 0.387, 0.129, 0.081, 0.113,
    0.387, 0.177, 0.194, 0.145, 0.081, 0.097, 0.516, 0.339, 0.129, 0.323
);
const WINE_F6: array<f32, 30> = array<f32, 30>(
    0.135, 0.108, 0.189, 0.112, 0.135, 0.358, 0.162, 0.139, 0.293, 0.366,
    0.062, 0.085, 0.097, 0.100, 0.200, 0.062, 0.281, 0.139, 0.108, 0.089,
    0.404, 0.185, 0.185, 0.166, 0.139, 0.189, 0.420, 0.362, 0.127, 0.347
);
const WINE_F7: array<f32, 30> = array<f32, 30>(
    0.345, 0.287, 0.424, 0.345, 0.345, 0.417, 0.380, 0.352, 0.396, 0.366,
    0.294, 0.308, 0.301, 0.273, 0.345, 0.294, 0.431, 0.352, 0.308, 0.294,
    0.459, 0.338, 0.424, 0.387, 0.287, 0.280, 0.452, 0.431, 0.266, 0.431
);
const WINE_F8: array<f32, 30> = array<f32, 30>(
    0.471, 0.397, 0.353, 0.412, 0.471, 0.338, 0.309, 0.382, 0.338, 0.382,
    0.456, 0.382, 0.397, 0.353, 0.412, 0.456, 0.294, 0.382, 0.471, 0.382,
    0.309, 0.397, 0.279, 0.353, 0.485, 0.529, 0.250, 0.338, 0.471, 0.338
);
const WINE_F9: array<f32, 30> = array<f32, 30>(
    0.259, 0.296, 0.259, 0.370, 0.259, 0.296, 0.185, 0.333, 0.296, 0.296,
    0.407, 0.333, 0.370, 0.259, 0.296, 0.407, 0.222, 0.333, 0.296, 0.370,
    0.296, 0.296, 0.222, 0.296, 0.296, 0.185, 0.185, 0.333, 0.407, 0.407
);
const WINE_F10: array<f32, 30> = array<f32, 30>(
    0.400, 0.433, 0.400, 0.500, 0.400, 0.367, 0.467, 0.467, 0.367, 0.433,
    0.567, 0.567, 0.567, 0.600, 0.433, 0.567, 0.367, 0.467, 0.467, 0.533,
    0.400, 0.500, 0.433, 0.533, 0.467, 0.400, 0.333, 0.467, 0.567, 0.467
);

// Target quality values (normalized)
const WINE_Y: array<f32, 30> = array<f32, 30>(
    0.5, 0.5, 0.5, 0.6, 0.5, 0.5, 0.5, 0.6, 0.5, 0.6,
    0.6, 0.6, 0.6, 0.6, 0.5, 0.6, 0.5, 0.6, 0.5, 0.6,
    0.6, 0.7, 0.5, 0.6, 0.5, 0.4, 0.6, 0.6, 0.7, 0.6
);

// sigmoid is already defined in the base shader

fn custom_loss(pos: array<f32, 256>, dim: u32) -> f32 {
    var total_loss = 0.0;

    for (var i = 0u; i < WINE_SIZE; i = i + 1u) {
        // Get input features
        let x = array<f32, 11>(
            WINE_F0[i], WINE_F1[i], WINE_F2[i], WINE_F3[i], WINE_F4[i],
            WINE_F5[i], WINE_F6[i], WINE_F7[i], WINE_F8[i], WINE_F9[i], WINE_F10[i]
        );

        // Layer 1: 11 -> 4 (tanh)
        var h: array<f32, 4>;
        for (var j = 0u; j < 4u; j = j + 1u) {
            var sum = pos[44u + j]; // bias
            for (var k = 0u; k < 11u; k = k + 1u) {
                sum = sum + pos[j * 11u + k] * x[k];
            }
            h[j] = tanh(sum);
        }

        // Layer 2: 4 -> 1 (sigmoid)
        var out = pos[52]; // bias
        for (var j = 0u; j < 4u; j = j + 1u) {
            out = out + pos[48u + j] * h[j];
        }
        let pred = sigmoid(out);

        // MSE loss
        let y_target = WINE_Y[i];
        let err = pred - y_target;
        total_loss = total_loss + err * err;
    }

    return total_loss / f32(WINE_SIZE);
}
